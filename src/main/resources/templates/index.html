<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Bucket Information</title>
    <link rel="stylesheet" href="https://cdn.bootcss.com/layui/2.6.0/css/layui.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        .container {
            background-color: #fff;
            border-radius: 8px;
            margin: 20px auto;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 90%;
        }

        h1 {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
        }

        .layui-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .layui-table td {
            vertical-align: middle;
        }

        img {
            max-width: 100px;
            max-height: 100px;
            cursor: pointer;
        }

        img:hover {
            transform: scale(1.1);
            transition: transform 0.3s;
        }
        /* Using CSS styles to limit label text length and add ellipsis */
        .layui-form-label {
            white-space: nowrap;
            max-width: 700px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="layui-form">
        <div class="layui-form-item">
            <label class="layui-form-label">Bucket Type</label>
            <div class="layui-input-block">
                <select id="bucketType" name="bucketType" lay-filter="bucketTypeSelect">
                    <option value="">Select a bucket type</option>
                    <th:block th:each="type : ${types}">
                        <option th:text="${type}"></option>
                    </th:block>
                </select>
            </div>
        </div>
    </div>

    <h1>Bucket Information</h1>
    <!-- Add New button -->
    <div id="addButtonDiv">
        <button id="addButton" class="layui-btn layui-btn-primary">Add New</button>
    </div>
    <table class="layui-table">
        <thead>
        <tr>
            <th>Bucket Name</th>
            <th>Object Key</th>
            <th>Description</th>
            <th>Image</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="bucketDetails">
        <!-- Data will be inserted here -->
        </tbody>
    </table>



</div>

<!-- Add New dialog template -->
<div style="display: none;" id="addTemplate">
    <input type="text" id="bucketName" placeholder="Bucket Name" class="layui-input" style="margin: 10px 0;">
    <input type="text" id="bucketTypeSource" placeholder="Bucket Type" class="layui-input" style="margin: 10px 0;">
    <input type="file" id="fileInput" multiple>
</div>

<script src="https://cdn.bootcss.com/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/layui/2.6.0/layui.js"></script>
<script>
    layui.use(['form', 'jquery', 'layer'], function () {
        var form = layui.form;
        var $ = layui.$;
        var layer = layui.layer;

        // Get bucket types
        $.ajax({
            url: '/content/hub/api/db/bu/info',
            type: 'GET',
            success: function (data) {
                var bucketTypes = data.data;
                var typeSelect = $('#bucketType');
                for (var i = 0; i < bucketTypes.length; i++) {
                    typeSelect.append('<option value="' + bucketTypes[i] + '">' + bucketTypes[i] + '</option>');
                }
                form.render('select');
            },
            error: function () {
                console.error('Error fetching bucket types.');
            }
        });

        // Listen for bucket type selection
        form.on('select(bucketTypeSelect)', function (data) {
            var selectedType = data.value;
            $.ajax({
                url: '/content/hub/api/db/bu/list?bucketType=' + selectedType,
                type: 'GET',
                success: function (data) {
                    displayBucketDetails(data.data);
                },
                error: function () {
                    console.error('Error fetching bucket details.');
                }
            });
        });

        // Display bucket details
        function displayBucketDetails(data) {
            var detailsHtml = '';
            for (var i = 0; i < data.length; i++) {
                detailsHtml += '<tr>';
                detailsHtml += '<td>' + data[i].bucketName + '</td>';
                detailsHtml += '<td>' + data[i].objectKey + '</td>';
                detailsHtml += '<td>' + data[i].description + '</td>';
                detailsHtml += '<td><img src="' + data[i].imageUrl + '" alt="Image" data-image-url="' + data[i].imageUrl + '"></td>';
                detailsHtml += '<td><button class="delete-button" data-id="' + data[i].id + '">Delete</button></td>';
                detailsHtml += '</tr>';
            }
            $('#bucketDetails').html(detailsHtml);

            // Bind click event to show image preview
            $('img').on('click', function () {
                var imageUrl = $(this).data('image-url');
                previewImage(imageUrl);
            });

            // Bind click event to execute delete operation
            $('.delete-button').on('click', function () {
                var id = $(this).data('id');
                // Call the delete function to send a request to the backend
                deleteBucketItem(id);
            });
        }

        // Delete bucket item
        function deleteBucketItem(id) {
            $.ajax({
                url: '/content/hub/api/db/bu/del/' + id,
                type: 'DELETE',
                success: function (result) {
                    if (result.code === 200) {
                        refreshData();
                    } else {
                        alert('Delete operation failed: ' + result.message);
                    }
                },
                error: function () {
                    console.error('Error deleting bucket item.');
                }
            });
        }

        // Show image preview
        function previewImage(imageUrl) {
            layer.open({
                type: 1,
                title: false,
                closeBtn: 1,
                area: 'auto',
                skin: 'layui-layer-nobg',
                shadeClose: true,
                content: '<img src="' + imageUrl + '" style="max-width: 100%; max-height: 100%;">'
            });
        }

        // Open the dialog when the "Add New" button is clicked
        $('#addButton').on('click', function () {
            layer.open({
                type: 1,
                title: 'Add New Bucket',
                area: ['500px', '300px'],
                content: $('#addTemplate'),
                btn: ['Confirm', 'Cancel'],
                yes: function (index, layero) {
                    var bucketName = $('#bucketName').val();
                    var bucketTypeSource = $('#bucketTypeSource').val();
                    var files = document.getElementById('fileInput').files;
                    if (!bucketName || !bucketTypeSource || files.length === 0) {
                        alert('Please fill in all fields and select at least one file.');
                    } else {
                        // Create a FormData object to send files and data
                        var formData = new FormData();
                        formData.append('bucketName', bucketName);
                        formData.append('bucketType', bucketTypeSource);
                        for (var i = 0; i < files.length; i++) {
                            formData.append('file', files[i]);
                        }

                        // Send the request to upload files
                        $.ajax({
                            url: '/content/hub/api/db/bu/upload',
                            type: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false,
                            success: function (result) {
                                if (result.code === 200) {
                                    refreshData();
                                    layer.close(index); // Close the dialog on success
                                } else {
                                    alert('Upload failed: ' + result.message);
                                }
                            },
                            error: function () {
                                console.error('Error uploading files.');
                            }
                        });
                    }
                }
            });
        });

        // Refresh data function
        function refreshData() {
            var selectedType = $('#bucketType').val();
            $.ajax({
                url: '/content/hub/api/db/bu/list?bucketType=' + selectedType,
                type: 'GET',
                success: function (data) {
                    displayBucketDetails(data.data);
                },
                error: function () {
                    console.error('Error fetching bucket details.');
                }
            });
        }
    });
</script>
</body>
</html>
